# 不動産投資シミュレーション機能改修：設計とマイルストーン

## 1. はじめに

本ドキュメントは、不動産投資シミュレーション機能におけるドメインモデルの変更に伴う、フロントエンド（Next.js, Zustand, React Hook Form, Recharts）の改修作業に関する設計方針と作業マイルストーンを定義するものです。

**背景:**
既存のドメインモデルが新しいものに置き換えられました。これに伴い、ユーザーインターフェース（特にデータ入力部分）、状態管理（Zustand ストア）、およびドメインモデルとの連携部分に修正が必要となっています。

**目的:**

- 新しいドメインモデルとフロントエンドコンポーネントを正しく連携させる。
- ユーザーが入力した情報に基づいて、Zustand ストアを経由し、ドメインモデルでシミュレーション計算を実行する。
- 計算結果を Recharts を用いてグラフとして分かりやすく表示する。
- 改修作業を円滑に進めるための明確なステップを定義する。

## 2. 設計方針

### 2.1. データフロー

改修後のデータフローは以下の通りです。

```mermaid
graph TD
    A[ユーザー入力画面 (src/app/simulation/page.tsx)] -- フォーム入力 --> B(入力コンポーネント群 (src/components/molecules, src/components/organism/PropertyInformation.tsx))
    B -- React Hook Form & Zustandアクション呼び出し --> C{Zustandストア (src/store/usePropertyStore.ts)}
    C -- ストア更新 & 計算アクション実行 --> D[ドメインモデル (src/domain/**)]
    D -- 計算処理 --> C
    C -- 計算結果をストアに保存 --> E[グラフ表示コンポーネント (src/components/organism/SimulationChart.tsx)]
    E -- Rechartsでグラフ描画 --> F[シミュレーション結果表示 (src/app/simulation/page.tsx)]
```

### 2.2. 主要コンポーネントとストアの役割

- **入力コンポーネント (`src/components/molecules/*Input.tsx`, `src/components/organism/PropertyInformation.tsx`)**:
  - ユーザーからの各種不動産情報（物件価格、利回り、築年数など）の入力を受け付けます。
  - React Hook Form を利用してフォームの状態管理とバリデーションを行います。
  - 入力値が変更された際、またはフォーム送信時に、Zustand ストアのアクションを呼び出して状態を更新します。
- **Zustand ストア (`src/store/usePropertyStore.ts`)**:
  - ユーザーが入力した不動産情報、ローン情報、運営戦略などの状態を一元管理します。
  - 新しいドメインモデルの計算ロジックを呼び出すアクションを定義します。このアクションは、ストア内の入力値を取得し、ドメインモデルの関数に適切な形式で渡します。
  - ドメインモデルから返された計算結果（キャッシュフロー、収支バランスシートなど）をストアの状態として保持します。
- **ドメインモデル (`src/domain/**`)\*\*:
  - UI に依存しない純粋なビジネスロジックとして、不動産投資のシミュレーション計算を実行します。
  - 入力として各種パラメータを受け取り、計算結果を返します。
  - 既存の `src/domain/property/property.ts`, `src/domain/propertyIncome/propertyIncome.ts`, `src/domain/propertyCost/propertyCost.ts`, `src/domain/financial-plan/propertyBalanceSheet.ts` などが連携して動作します。
- **グラフ表示コンポーネント (`src/components/organism/SimulationChart.tsx`)**:
  - Zustand ストアからシミュレーションの計算結果（時系列データなど）を購読します。
  - Recharts ライブラリを使用して、受け取ったデータをグラフとして視覚化します。

### 2.3. 型定義の整合性

ドメインモデルの変更に伴い、関連する全ての型定義を見直し、一貫性を確保します。

- **ドメインモデルの入力/出力型**: `src/domain/` 配下の各モジュールで定義されている関数の引数と戻り値の型。
- **Zustand ストアの状態型**: `src/store/usePropertyStore.ts` で定義されるストアの状態の型。これはドメインモデルの入力型と計算結果の型を包含する必要があります。
- **コンポーネントの Props 型**: 各入力コンポーネントや表示コンポーネントが受け取る Props の型。React Hook Form の `useForm` のジェネリクスにも影響します。

`.clinerules` に従い、すべての型定義は明示的に行い、JSDoc コメントで目的を説明します。

## 3. 作業マイルストーン

以下のマイルストーンに従って作業を進めます。

### フェーズ 1: ドメインモデルのインターフェース確認と型定義の更新 (見積もり: 2 日)

- [x] **タスク 1.1**: 新しいドメインモデルの主要な計算関数（例: `calculateCashFlow`, `generateBalanceSheet` など）のシグネチャ（引数、戻り値）を特定し、ドキュメント化する。
  - **成果物**: ドメインモデルのインターフェース仕様（簡易的なもので可）。
- [x] **タスク 1.2**: ドメインモデルの入力に必要なデータ項目を全て洗い出す。
  - **成果物**: 入力データ項目リストとそれぞれの型。
- [x] **タスク 1.3**: ドメインモデルの計算結果として得られるデータ項目を全て洗い出す。
  - **成果物**: 出力データ項目リストとそれぞれの型。
- [x] **タスク 1.4**: `src/store/usePropertyStore.ts` の状態の型定義を、タスク 1.2 および 1.3 で洗い出した型に合わせて更新する。
  - **成果物**: 更新された `usePropertyStore.ts` の型定義部分。
- [x] **タスク 1.5**: React Hook Form で使用するフォームデータの型定義を更新する。
  - **成果物**: フォームデータ用の型定義。

### フェーズ 2: Zustand ストアの修正 (見積もり: 3 日)

- [x] **タスク 2.1**: `usePropertyStore` の初期状態を、新しいドメインモデルの入力パラメータに合わせて修正する。
  - **成果物**: 更新された `usePropertyStore.ts` の初期状態部分。
- [x] **タスク 2.2**: ユーザー入力をストアに保存するためのアクション（セッター関数）を修正・追加する。
  - **成果物**: 更新された `usePropertyStore.ts` のセッターアクション部分。
- [x] **タスク 2.3**: ドメインモデルの計算を実行する新しいアクション（例: `runSimulation`）を実装する。
  - このアクションはストア内の入力値を取得し、ドメインモデルの計算関数を呼び出し、結果をストアに保存します。
  - ドメインモデルの関数呼び出しは非同期になる可能性も考慮します（現状は純粋関数なので同期処理が主と想定）。
  - **成果物**: `runSimulation` アクションが実装された `usePropertyStore.ts`。
- [x] **タスク 2.4**: ストアの単体テストを作成または更新し、新しい状態とアクションが正しく動作することを確認する。
  - **成果物**: `usePropertyStore.test.ts` (または同様のテストファイル)。

### フェーズ 3: 入力コンポーネントの修正 (見積もり: 4 日)

- [ ] **タスク 3.1**: `src/components/organism/PropertyInformation.tsx` およびその配下の各入力コンポーネント (`src/components/molecules/*Input.tsx`) を見直す。
  - React Hook Form の `useForm` に新しいフォームデータの型を適用する。
  - 各入力フィールドが、Zustand ストアの新しい状態およびアクションと正しく連携するように修正する。
  - `name` 属性や `register` の使い方を確認し、ストアのキーと一致させる。
  - **成果物**: 修正された各入力コンポーネントファイル。
- [ ] **タスク 3.2**: フォームの送信処理を修正し、Zustand ストアの `runSimulation` アクションを呼び出すようにする。
  - **成果物**: 修正されたフォーム送信処理部分。
- [ ] **タスク 3.3**: 各入力コンポーネントのバリデーションルールを、新しいドメインモデルの要件に合わせて更新する。
  - **成果物**: 更新されたバリデーションロジック。
- [ ] **タスク 3.4**: Ladle 用のストーリーファイル (`.stories.tsx`) を更新し、修正されたコンポーネントが正しく表示・動作することを確認する。
  - **成果物**: 更新されたストーリーファイル。

### フェーズ 4: グラフ表示コンポーネントの連携確認 (見積もり: 2 日)

- [ ] **タスク 4.1**: `src/components/organism/SimulationChart.tsx` が、修正された Zustand ストアから正しい計算結果（グラフ描画に必要なデータ）を取得できるようにする。
  - ストアから購読するセレクタを見直す。
  - **成果物**: 修正された `SimulationChart.tsx`。
- [ ] **タスク 4.2**: Recharts コンポーネントに渡すデータ構造が、新しい計算結果の形式と一致していることを確認し、必要であれば修正する。
  - **成果物**: 修正されたデータマッピング部分。
- [ ] **タスク 4.3**: グラフが意図通りに描画されることを確認する。表示項目やデザインに変更があれば対応する。
  - **成果物**: 正常に描画されるグラフ。

### フェーズ 5: 統合テストとデバッグ (見積もり: 2 日)

- [ ] **タスク 5.1**: `src/app/simulation/page.tsx` を中心に、全体のデータフロー（ユーザー入力 → ストア更新 → ドメイン計算 → 結果表示 → グラフ描画）を通してテストする。
  - 複数のシナリオ（異なる入力値の組み合わせ）でテストを実施する。
  - **成果物**: テストケースリストと実行結果。
- [ ] **タスク 5.2**: 発見されたバグや不整合を修正する。
  - **成果物**: 修正されたコード。
- [ ] **タスク 5.3**: ブラウザのコンソールエラーや警告がないことを確認する。
  - **成果物**: クリーンなコンソールログ。

## 4. その他考慮事項

- **エラーハンドリング**: ドメインモデルの計算時やデータの取得時にエラーが発生した場合のハンドリングを検討する（例: ユーザーへのフィードバック表示）。
- **パフォーマンス**: 大量のデータを扱う場合や計算が複雑な場合、パフォーマンスへの影響を考慮する。必要に応じて最適化を行う。
- **コードレビュー**: 各フェーズの主要な変更点については、チーム内でのコードレビューを実施する。

以上
